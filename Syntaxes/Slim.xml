<?xml version="1.0"?>
<syntax name="language-root.slim">

    <zones>
        <include collection="items" />      
        <include collection="strings" />
        <include collection="entities" />
    </zones>
    
    
    <library>	
    	<collection name="items">
    		        
	        <zone name="item.item-body">
				<starts-with>
					<expression>^((?!\-)([a-zA-Z0-9:_-]+)((?:\s+[\w]+[=]["|']([ \w\d:_-\{\}]+)?["|'])*)|(([#|\.])(\w+)(?:([#|\.])(\w+))*))</expression>
					<capture number="1" name="tag-def">
						<subzones>
							<include collection="tags" />
						</subzones>
					</capture>
	        	</starts-with>
	        	<ends-with>^(?![ \t]|[ \t]*$)</ends-with>
	        	<subzones>
	        		<include collection="nested-items" />
	        	</subzones>
	        </zone>
        </collection>
                
		<collection name="nested-items">
			<zone name="item">
					<starts-with>
		    			<expression>^([ \t]+)((?!\-)([a-zA-Z0-9:_-]+)((?:\s+[\w]+[=]["|']([ \w\d:_-\{\}]+)?["|'])*)|(([#|\.])(\w+)(?:([#|\.])(\w+))*))</expression>
		    			<capture number="2" name="tag-def">
		    				<subzones>
		    					<include collection="tags" />
		    				</subzones>
		    			</capture>
		    		</starts-with>
					<ends-with>^(?!\1[ \t]|[ \t]*$)</ends-with>
					<subzones name="item-body">
						<include collection="nested-items" />
					</subzones>
			</zone>
		</collection>
		
        <collection name="tags">
        	<zone name="tag.inline-block">
        		<expression>^(?!\-)([a-zA-Z0-9:_-]+)((?:\s+[\w]+[=]["|']([ \w\d:_-\{\}]+)?["|'])*)</expression>
        		<capture number="1" name="entity.name"/>
        		<capture number="2" name="attributes">
        			<subzones>
        				<include collection="tag-attributes" />
        			</subzones>
        		</capture>
        	</zone>
        	
        	<zone name="tag.shortcut">
        		<expression>^([#|\.])(\w+)(?:([#|\.])(\w+))*</expression>
        		<capture number="1" name="punctuation.definition"/>
        		<capture number="2" name="entity.name"/>
        	</zone>
        	
        </collection>
      
<!--        <collection name="nested-static">
        	<zone name="static-text">
        		<expression>^(?:[\s*]+)(\| |' )</expression>
        		<capture number="1" name="punctuation.definition" />
        	</zone>
        </collection>-->
        
        <collection name="tag-attributes">
        	<!--CSS embedded attributes-->
        	<zone>
        		<expression>\s+(style)(=)((")([^"]*)("))</expression>
        		<capture number="1" name="attribute-name.style"/>
        		<capture number="2" name="punctuation.separator.attribute"/>
        		<capture number="3" name="string.quoted.double"/>
        		<capture number="4" name="punctuation.definition.begin"/>
        		<capture number="5" name="embedded.property-list.css">
        			<subzones>
        				<include syntax="language-root.css" collection="properties"/>
        			</subzones>
        		</capture>
        		<capture number="6" name="punctuation.definition.end"/>
        	</zone>
        	<zone>
        		<expression>\s+(style)(=)((')([^']*)('))</expression>
        		<capture number="1" name="attribute-name.style"/>
        		<capture number="2" name="punctuation.separator.attribute"/>
        		<capture number="3" name="string.quoted.single"/>
        		<capture number="4" name="punctuation.definition.begin"/>
        		<capture number="5" name="embedded.property-list.css">
        			<subzones>
        				<include syntax="language-root.css" collection="properties"/>
        			</subzones>
        		</capture>
        		<capture number="6" name="punctuation.definition.end"/>
        	</zone>
        	<!--Javascript embedded attributes-->
        	<zone>
        		<expression>\s+(on[a-zA-Z]+)(=)((")(.*?)((?&lt;!\\)"))</expression>
        		<capture number="1" name="attribute-name.js"/>
        		<capture number="2" name="punctuation.separator.attribute"/>
        		<capture number="3" name="string.quoted.double"/>
        		<capture number="4" name="punctuation.definition.begin"/>
        		<capture number="5" name="embedded.sourcecode.js">
        			<subzones>
        				<include syntax="language-root.js"/>
        			</subzones>
        		</capture>
        		<capture number="6" name="punctuation.definition.end"/>
        	</zone>
        	<zone>
        		<expression>\s+(on[a-zA-Z]+)(=)((')(.*?)((?&lt;!\\)'))</expression>
        		<capture number="1" name="attribute-name.js"/>
        		<capture number="2" name="punctuation.separator.attribute"/>
        		<capture number="3" name="string.quoted.single"/>
        		<capture number="4" name="punctuation.definition.begin"/>
        		<capture number="5" name="embedded.sourcecode.js">
        			<subzones>
        				<include syntax="language-root.js"/>
        			</subzones>
        		</capture>
        		<capture number="6" name="punctuation.definition.end"/>
        	</zone>
        	<!--Generic attributes-->
            <zone>
                <expression>\s+([-_a-zA-Z0-9:]+)(=)</expression>
                <capture number="1" name="attribute-name">
        			<subzones>
        				<zone>
        					<expression>([^:]+)(:)(.*)</expression>
        					<capture number="1" name="namespace"/>
        					<capture number="2" name="punctuation.separator"/>
        					<capture number="3" name="localname"/>
        				</zone>
        			</subzones>
        		</capture>
                <capture number="2" name="punctuation.separator.attribute"/>
                <capture number="3" name="punctuation.separator.namespace"/>
            </zone>
            <include collection="strings"/>
        </collection>
        
        <collection name="strings">
            <zone name="attribute-value.string.quoted.double">
                <starts-with>
                    <expression>"</expression>
                    <capture number="0" name="punctuation.definition.begin"/>
                </starts-with>
                <ends-with>
                    <expression>"</expression>
                    <capture number="0" name="punctuation.definition.end"/>
                </ends-with>
        		<subzones name="attribute-value.value" />
            </zone>
            <zone name="attribute-value.string.quoted.single">
                <starts-with>
                    <expression>'</expression>
                    <capture number="0" name="punctuation.definition.begin"/>
                </starts-with>
                <ends-with>
                    <expression>'</expression>
                    <capture number="0" name="punctuation.definition.end"/>
                </ends-with>
        		<subzones name="attribute-value.value" />
            </zone>
        </collection>
        
        <collection name="entities">
        	<zone name="constant.character.entity.slim">
        		<expression>(&amp;)([a-zA-Z0-9]+|#[0-9]+|#x[0-9a-fA-F]+)(;)</expression>
        		<capture number="1" name="punctuation.definition.entity.html"/>
        		<capture number="3" name="punctuation.definition.entity.html"/>
        	</zone>
        	<zone name="invalid.illegal.bad-ampersand.slim">
        		<expression>&amp;</expression>
        	</zone>
        </collection>
        
    </library>
    
</syntax>